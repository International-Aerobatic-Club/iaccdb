<h3><%= c_result.display_category %></h3>

<table class='pilot_results'><thead><tr>
  <th colspan='2'>Pilot</th>
<% flight_order = [] %>
<% c_result.f_results.order(:id).each do |f_result| %>
  <th colspan='3'>
  <%= link_to(f_result.flight.name, flight_path(f_result.flight)) %>
  <% flight_order << f_result.id %>
  </th>
<% end %>
<th colspan='3'>Total</th>
</tr></thead><tbody>
<% c_result.pc_results.order(:category_rank).each do |pc_result| %>
<tr>
  <% pilot = pc_result.pilot %>
  <td class='star'>
    <%= pc_result.star_qualifying ? '*' : ' ' %>
  </td>
  <td class="pilot">
    <%= link_to("#{pilot.name}", pilot_score_path(pilot, @contest)) %>
  </td>
  <% total_possible = 0 %>
  <% flight_index = 0 %>
  <% pc_result.pf_results.order(:f_result_id).each do |pf_result| %>
    <!-- insert and blank columns -->
    <% while flight_index < flight_order.size && 
             pf_result.f_result_id != flight_order[flight_index] do %>
      <td colspan='3'/>
      <% flight_index += 1 %>
    <% end %>
    <% flight_index += 1 %>
    <td class='total_average'>
      <%= sprintf('%.02f', pf_result.adj_flight_value) %>
    </td>
    <% possible = pf_result.pilot_flight.sequence.total_k %>
    <td class='percentage'>
      <%= sprintf('%.02f', pf_result.adj_flight_value * 10.0 / possible) %>%
    </td>
    <% total_possible += possible %>
    <td class='rank'>(<%= pf_result.adj_flight_rank %>)</td>
  <% end %>
  <% while flight_index < flight_order.size do %>
    <td colspan='3'/>
    <% flight_index += 1 %>
  <% end %>
  <td class='total_average'>
    <%= sprintf('%.02f', pc_result.category_value) %>
  </td>
  <td class='percentage'>
    <%= sprintf('%.02f', pc_result.category_value * 10.0 / total_possible) %>%
  </td>
  <td class='rank'>(<%= pc_result.category_rank %>)</td>
</tr>
<% end %>
</tbody></table>
<%= render :template => 'judges/results',
  :locals => { :j_results => c_result.jc_results } %>
